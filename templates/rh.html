{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Painel RH</h2>

    <!-- Abas -->
    <ul class="nav nav-tabs" id="rhTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#usuarios"
                type="button">Usuários</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#colaboradores"
                type="button">Colaboradores</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#estoque"
                type="button">Estoque</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#kits"
                type="button">Kits</button></li>
    </ul>

    <div class="tab-content mt-3">

        <!-- ===================== USUÁRIOS ===================== -->
        <div class="tab-pane fade show active" id="usuarios">
            <h4 class="mb-3">Gerenciar Usuários</h4>

            <div class="row g-2 mb-3 align-items-center">
                <div class="col-md-4">
                    <select id="usersFiltroColuna" class="form-select">
                        <option value="">Filtrar por…</option>
                        <option value="u-id">ID</option>
                        <option value="u-login">Login</option>
                        <option value="u-nome">Nome</option>
                        <option value="u-email">Email</option>
                        <option value="u-classe">Classe</option>
                    </select>
                </div>
                <div class="col-md-5">
                    <input id="usersFiltroValor" class="form-control d-none" placeholder="Digite para filtrar…">
                </div>
                <div class="col-md-3 text-md-end">
                    <button class="btn btn-success" data-bs-toggle="modal"
                        data-bs-target="#modalAdicionarUsuario">Adicionar</button>
                </div>
            </div>

            <table class="table table-striped" id="tabelaUsuarios">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Login</th>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Classe</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in usuarios %}
                    <tr>
                        <td class="u-id">{{ u.id_usuario|default('-', true) }}</td>
                        <td class="u-login">{{ u.usuario|default('-', true) }}</td>
                        <td class="u-nome">{{ u.nome|default('-', true) }}</td>
                        <td class="u-email">{{ u.email|default('-', true) }}</td>
                        <td class="u-classe">{{ u.nome_classe|default('-', true) }}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal"
                                data-bs-target="#modalEditarUsuario-{{ u.id_usuario }}"><i
                                    class="bi bi-pencil-fill"></i></button>
                            <button class="btn btn-danger btn-sm" data-bs-toggle="modal"
                                data-bs-target="#modalExcluirUsuario-{{ u.id_usuario }}"><i
                                    class="bi bi-trash-fill"></i></button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Modais Usuário -->
            {% for u in usuarios %}
            <div class="modal fade" id="modalEditarUsuario-{{ u.id_usuario }}" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <form method="post" action="{{ url_for('rh') }}">
                            <div class="modal-header">
                                <h5 class="modal-title">Editar Usuário</h5><button type="button" class="btn-close"
                                    data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row g-3">
                                    <div class="col-md-2">
                                        <label class="form-label">ID</label>
                                        <input name="id_usuario" class="form-control" value="{{ u.id_usuario }}"
                                            readonly>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Login</label>
                                        <input name="usuario" class="form-control" value="{{ u.usuario }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Nova Senha</label>
                                        <input name="senha" type="password" class="form-control"
                                            placeholder="Nova senha">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Nome</label>
                                        <input name="nome" class="form-control" value="{{ u.nome }}">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Email</label>
                                        <input name="email" type="email" class="form-control" value="{{ u.email }}">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Classe ID</label>
                                        <input name="id_classe" class="form-control" value="{{ u.id_classe }}">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Classe Nome</label>
                                        <select name="nome_classe" class="form-select" required>
                                            <option value="" disabled>Selecione</option>
                                            {% set classes = class_map.keys()|list %}
                                            {% for nome in ['Administrador','Almoxarifado','GA','RH'] %}
                                            <option value="{{ nome }}" {% if u.nome_classe==nome %}selected{% endif %}>
                                                {{ nome }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" name="editar_usuario" class="btn btn-primary">Salvar</button>
                                <button type="button" class="btn btn-secondary"
                                    data-bs-dismiss="modal">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="modalExcluirUsuario-{{ u.id_usuario }}" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirmar Exclusão</h5><button type="button" class="btn-close"
                                data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">Tem certeza que deseja excluir <strong>{{ u.nome }}</strong>?</div>
                        <div class="modal-footer">
                            <form method="post" action="{{ url_for('remover_usuario') }}">
                                <input type="hidden" name="id_usuario" value="{{ u.id_usuario }}">
                                <button type="submit" class="btn btn-danger">Excluir</button>
                            </form>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- ===================== COLABORADORES ===================== -->
        <div class="tab-pane fade" id="colaboradores">
            <h4 class="mb-3">Colaboradores</h4>

            <div class="row g-2 mb-3 align-items-center">
                <div class="col-md-4">
                    <select id="colabFiltroColuna" class="form-select">
                        <option value="">Filtrar por…</option>
                        <option value="c-id">ID</option>
                        <option value="c-nome">Nome</option>
                        <option value="c-email">Email</option>
                        <option value="c-gestor">Nome GA</option>
                        <option value="c-egestor">Email GA</option>
                        <option value="c-idkit">ID Kit</option>
                        <option value="c-kit">Nome Kit</option>
                        <option value="c-adm">Data Admissão</option>
                        <option value="c-tam">Tam. Camisa</option>
                        <option value="c-idag">ID Agência</option>
                        <option value="c-ag">Nome Agência</option>
                        <option value="c-loc">Local Envio</option>
                        <option value="c-sit">Situação</option>
                    </select>
                </div>
                <div class="col-md-5">
                    <input id="colabFiltroValor" class="form-control d-none" placeholder="Digite para filtrar…">
                </div>
                <!-- <div class="col-md-3 text-md-end">
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAdicionarColaborador">
                        Adicionar
                    </button>
                </div> -->
            </div>

            <table class="table table-hover" id="tabelaColaboradores">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Nome GA</th>
                        <th>Email GA</th>
                        <th>ID Kit</th>
                        <th>Nome Kit</th>
                        <th>Data Admissão</th>
                        <th>Tam. Camisa</th>
                        <th>ID Agência</th>
                        <th>Nome Agência</th>
                        <th>Local Envio</th>
                        <th>Situação</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in colaboradores %}
                    <tr>
                        <td class="c-id">{{ c.id_colaborador|default('-', true) }}</td>
                        <td class="c-nome">{{ c.nome_colaborador|default('-', true) }}</td>
                        <td class="c-email">{{ c.email_colaborador|default('-', true) }}</td>
                        <td class="c-gestor">{{ c.nome_gestor|default('-', true) }}</td>
                        <td class="c-egestor">{{ c.email_gestor|default('-', true) }}</td>
                        <td class="c-idkit">{{ c.id_kit|default('-', true) }}</td>
                        <td class="c-kit">{{ c.nome_kit|default('-', true) }}</td>
                        <td class="c-adm">{{ c.data_admissao|default('-', true) }}</td>
                        <td class="c-tam">{{ c.tamanho_camisa|default('-', true) }}</td>
                        <td class="c-idag">{{ c.id_agencia|default('-', true) }}</td>
                        <td class="c-ag">{{ c.nome_agencia|default('-', true) }}</td>
                        <td class="c-loc">{{ c.local_envio|default('-', true) }}</td>
                        <td class="c-sit"><span class="fw-bold">{{ c.situacao|default('-', true) }}</span></td>
                        <td>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal"
                                data-bs-target="#modalEditarColaborador-{{ c.id_colaborador }}"><i
                                    class="bi bi-pencil-fill"></i></button>
                            <button class="btn btn-danger btn-sm" data-bs-toggle="modal"
                                data-bs-target="#modalExcluirColaborador-{{ c.id_colaborador }}"><i
                                    class="bi bi-trash-fill"></i></button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            {% for c in colaboradores %}
            <!-- Editar Colaborador -->
            <div class="modal fade" id="modalEditarColaborador-{{ c.id_colaborador }}" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <form method="post" action="{{ url_for('rh') }}">
                            <div class="modal-header">
                                <h5 class="modal-title">Editar Colaborador</h5><button type="button" class="btn-close"
                                    data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row g-3">
                                    <div class="col-md-3"><label class="form-label">ID</label><input
                                            name="id_colaborador" class="form-control" value="{{ c.id_colaborador }}"
                                            readonly></div>
                                    <div class="col-md-4"><label class="form-label">Nome</label><input
                                            name="nome_colaborador" class="form-control"
                                            value="{{ c.nome_colaborador }}"></div>
                                    <div class="col-md-5"><label class="form-label">Email</label><input
                                            name="email_colaborador" type="email" class="form-control"
                                            value="{{ c.email_colaborador }}"></div>
                                    <div class="col-md-3"><label class="form-label">GA ID</label><input
                                            name="id_gestor" class="form-control" value="{{ c.id_gestor }}"></div>
                                    <div class="col-md-4"><label class="form-label">Nome GA</label><input
                                            name="nome_gestor" class="form-control" value="{{ c.nome_gestor }}"></div>
                                    <div class="col-md-5"><label class="form-label">Email GA</label><input
                                            name="email_gestor" type="email" class="form-control"
                                            value="{{ c.email_gestor }}"></div>
                                    <div class="col-md-3"><label class="form-label">ID Kit</label><input name="id_kit"
                                            class="form-control" value="{{ c.id_kit }}"></div>
                                    <div class="col-md-4"><label class="form-label">Nome Kit</label><input
                                            name="nome_kit" class="form-control" value="{{ c.nome_kit }}"></div>
                                    <div class="col-md-3"><label class="form-label">Tamanho Camisa</label><input
                                            name="tamanho_camisa" class="form-control" value="{{ c.tamanho_camisa }}">
                                    </div>
                                    <div class="col-md-4"><label class="form-label">Agência ID</label><input
                                            name="id_agencia" class="form-control" value="{{ c.id_agencia }}"></div>
                                    <div class="col-md-4"><label class="form-label">Nome Agência</label><input
                                            name="nome_agencia" class="form-control" value="{{ c.nome_agencia }}"></div>
                                    <div class="col-md-4"><label class="form-label">Local Envio</label><input
                                            name="local_envio" class="form-control" value="{{ c.local_envio }}"></div>
                                    <div class="col-md-4"><label class="form-label">Data Admissão</label><input
                                            name="data_admissao" type="date" class="form-control"
                                            value="{{ c.data_admissao }}"></div>
                                    <div class="col-md-4">
                                        <label class="form-label">Situação</label>
                                        <select name="situacao" class="form-select">
                                            {% for s in ['Ativo','Inativo','pendente','montar','entregue','enviado'] %}
                                            <option value="{{ s }}" {% if c.situacao==s %}selected{% endif %}>{{ s }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer"><button type="submit" name="editar_colaborador"
                                    class="btn btn-primary">Salvar</button><button type="button"
                                    class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button></div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Excluir Colaborador -->
            <div class="modal fade" id="modalExcluirColaborador-{{ c.id_colaborador }}" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirmar Exclusão</h5><button type="button" class="btn-close"
                                data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">Tem certeza que deseja excluir <strong>{{ c.nome_colaborador
                                }}</strong>?</div>
                        <div class="modal-footer">
                            <form method="post" action="{{ url_for('rh') }}">
                                <input type="hidden" name="id_colaborador" value="{{ c.id_colaborador }}">
                                <button type="submit" name="remover_colaborador" class="btn btn-danger">Excluir</button>
                            </form>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- ===================== ESTOQUE ===================== -->
        <div class="tab-pane fade" id="estoque">
            <h4 class="mb-3">Estoque</h4>

            <div class="row g-2 mb-3 align-items-center">
                <div class="col-md-4">
                    <select id="estqFiltroColuna" class="form-select">
                        <option value="">Filtrar por…</option>
                        <option value="e-id">ID</option>
                        <option value="e-item">Item</option>
                        <option value="e-tam">Tamanho</option>
                        <option value="e-qtd">Quantidade</option>
                    </select>
                </div>
                <div class="col-md-8">
                    <input id="estqFiltroValor" class="form-control d-none" placeholder="Digite para filtrar…">
                </div>
            </div>

            <table class="table table-striped" id="tabelaEstoque">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Item</th>
                        <th>Tamanho</th>
                        <th>Quantidade</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in estoque %}
                    <tr>
                        <td class="e-id">{{ item.id_item|default('-', true) }}</td>
                        <td class="e-item">{{ item.item|default('-', true) }}</td>
                        <td class="e-tam">{{ item.tamanho_camisa|default('-', true) }}</td>
                        <td class="e-qtd">{{ item.qntd|default('0', true) }}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal"
                                data-bs-target="#modalEditarEstoque-{{ item.id_item }}"><i
                                    class="bi bi-pencil-fill"></i></button>
                            <button class="btn btn-danger btn-sm" data-bs-toggle="modal"
                                data-bs-target="#modalExcluirEstoque-{{ item.id_item }}"><i
                                    class="bi bi-trash-fill"></i></button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            {% for item in estoque %}
            <div class="modal fade" id="modalEditarEstoque-{{ item.id_item }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <form method="post" action="{{ url_for('rh') }}">
                            <input type="hidden" name="editar_estoque" value="1">
                            <input type="hidden" name="id_item" value="{{ item.id_item }}">
                            <div class="modal-header">
                                <h5 class="modal-title">Editar Estoque</h5><button type="button" class="btn-close"
                                    data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-4"><label class="form-label">ID do Item</label><input type="text"
                                            class="form-control" value="{{ item.id_item }}" readonly></div>
                                    <div class="col-md-4"><label class="form-label">Item</label><input type="text"
                                            class="form-control" value="{{ item.item }}" readonly></div>
                                    <div class="col-md-4">
                                        <label class="form-label">Tamanho</label>
                                        <select name="tamanho_camisa" class="form-select">
                                            {% for tamanho in ['PP','P','M','G','GG','XG'] %}
                                            <option value="{{ tamanho }}" {% if item.tamanho_camisa==tamanho
                                                %}selected{% endif %}>{{ tamanho }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-4"><label class="form-label">Quantidade</label><input
                                            type="number" name="qntd" class="form-control" value="{{ item.qntd }}"
                                            required></div>
                                </div>
                            </div>
                            <div class="modal-footer"><button type="submit"
                                    class="btn btn-primary">Salvar</button><button type="button"
                                    class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button></div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="modalExcluirEstoque-{{ item.id_item }}" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirmar Exclusão</h5><button type="button" class="btn-close"
                                data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">Tem certeza que deseja excluir o item <strong>{{ item.item }}</strong>
                            ({{ item.tamanho_camisa }})?</div>
                        <div class="modal-footer">
                            <form method="post" action="{{ url_for('rh') }}">
                                <input type="hidden" name="id_item" value="{{ item.id_item }}">
                                <button type="submit" name="remover_estoque" class="btn btn-danger">Excluir</button>
                            </form>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- ===================== KITS ===================== -->
        <div class="tab-pane fade" id="kits">
            <h4 class="mb-3">Kits</h4>

            <div class="row g-2 mb-3 align-items-center">
                <div class="col-md-4">
                    <select id="kitsFiltroColuna" class="form-select">
                        <option value="">Filtrar por…</option>
                        <option value="k-id">ID</option>
                        <option value="k-nome">Nome Kit</option>
                        <option value="k-item">Item</option>
                        <option value="k-tam">Tamanho</option>
                    </select>
                </div>
                <div class="col-md-5"><input id="kitsFiltroValor" class="form-control d-none"
                        placeholder="Digite para filtrar…"></div>
                <div class="col-md-3 text-md-end">
                    <button class="btn btn-success" data-bs-toggle="modal"
                        data-bs-target="#modalAdicionarKits">Adicionar</button>
                </div>
            </div>

            <table class="table table-striped" id="tabelaKits">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nome Kit</th>
                        <th>Item</th>
                        <th>Tamanho</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody>
                    {% for k in kits %}
                    <tr>
                        <td class="k-id">{{ k.id_kit|default('-', true) }}</td>
                        <td class="k-nome">{{ k.nome_kit|default('-', true) }}</td>
                        <td class="k-item">{{ k.item|default('-', true) }}</td>
                        <td class="k-tam">{{ k.tamanho_camisa|default('-', true) }}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal"
                                data-bs-target="#modalEditarKit-{{ k.id_kit }}"><i
                                    class="bi bi-pencil-fill"></i></button>
                            <button class="btn btn-danger btn-sm" data-bs-toggle="modal"
                                data-bs-target="#modalExcluirKit-{{ k.id_kit }}"><i
                                    class="bi bi-trash-fill"></i></button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            {% for k in kits %}
            <div class="modal fade" id="modalEditarKit-{{ k.id_kit }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <form method="post" action="{{ url_for('rh') }}">
                            <input type="hidden" name="editar_kit" value="1">
                            <input type="hidden" name="id_kit" value="{{ k.id_kit }}">
                            <div class="modal-header">
                                <h5 class="modal-title">Editar Kit</h5><button type="button" class="btn-close"
                                    data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-4"><label class="form-label">ID do Kit</label><input type="text"
                                            name="id_kit_edit" class="form-control" value="{{ k.id_kit }}" required>
                                    </div>
                                    <div class="col-md-8"><label class="form-label">Nome do Kit</label><input
                                            type="text" name="nome_kit" class="form-control" value="{{ k.nome_kit }}"
                                            required></div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-4"><label class="form-label">ID do Item</label><input type="text"
                                            name="id_item" class="form-control" value="{{ k.id_item }}"></div>
                                    <div class="col-md-8"><label class="form-label">Item</label><input type="text"
                                            name="item" class="form-control" value="{{ k.item }}"></div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Tamanho da Camisa</label>
                                        <select name="tamanho_camisa" class="form-select">
                                            <option value="" {% if not k.tamanho_camisa %}selected{% endif %}>—</option>
                                            {% for tamanho in ['PP','P','M','G','GG','XG'] %}
                                            <option value="{{ tamanho }}" {% if k.tamanho_camisa==tamanho %}selected{%
                                                endif %}>{{ tamanho }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer"><button type="submit" class="btn btn-primary">Salvar
                                    Alterações</button><button type="button" class="btn btn-secondary"
                                    data-bs-dismiss="modal">Cancelar</button></div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="modalExcluirKit-{{ k.id_kit }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirmar Exclusão</h5><button type="button" class="btn-close"
                                data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">Tem certeza que deseja excluir <strong>{{ k.nome_kit }}</strong>?</div>
                        <div class="modal-footer">
                            <form method="post" action="{{ url_for('rh') }}">
                                <input type="hidden" name="id_kit" value="{{ k.id_kit }}">
                                <button type="submit" name="remover_kit" class="btn btn-danger">Excluir</button>
                            </form>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- ===================== MODAIS ADIÇÃO ===================== -->

<!-- Adicionar Usuário -->
<div class="modal fade" id="modalAdicionarUsuario" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" action="{{ url_for('rh') }}">
                <div class="modal-header">
                    <h5 class="modal-title">Adicionar Usuário</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6"><label class="form-label">ID do Usuário</label><input name="id_usuario"
                                class="form-control" required></div>
                        <div class="col-md-6"><label class="form-label">Nome</label><input name="nome"
                                class="form-control" required></div>
                        <div class="col-md-6"><label class="form-label">Email</label><input name="email" type="email"
                                class="form-control" required></div>
                        <div class="col-md-6"><label class="form-label">Login</label><input name="usuario"
                                class="form-control" required></div>
                        <div class="col-md-6"><label class="form-label">Senha</label><input name="senha" type="password"
                                class="form-control" required></div>
                        <div class="col-md-6">
                            <label class="form-label">Classe</label>
                            <select name="nome_classe" class="form-select" required>
                                <option value="" disabled selected>Selecione</option>
                                {% for nome in ['Administrador','Almoxarifado','GA','RH'] %}
                                <option value="{{ nome }}">{{ nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6"><label class="form-label">ID da Classe</label><input name="id_classe"
                                class="form-control" required></div>
                    </div>
                </div>
                <div class="modal-footer"><button type="submit" name="adicionar_usuario"
                        class="btn btn-success">Adicionar</button><button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Cancelar</button></div>
            </form>
        </div>
    </div>
</div>



<!-- Adicionar Colaborador -->
<div class="modal fade" id="modalAdicionarColaborador" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" action="{{ url_for('rh') }}">
                <div class="modal-header">
                    <h5 class="modal-title">Adicionar Colaborador</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6"><label class="form-label">ID Colaborador</label><input
                                name="id_colaborador" class="form-control" required></div>
                        <div class="col-md-6"><label class="form-label">Nome do Colaborador</label><input
                                name="nome_colaborador" class="form-control" required></div>
                        <div class="col-md-6"><label class="form-label">Email do Colaborador</label><input
                                name="email_colaborador" type="email" class="form-control" required></div>
                        <div class="col-md-6"><label class="form-label">ID GA</label><input name="id_gestor"
                                class="form-control" required></div>
                        <div class="col-md-6"><label class="form-label">Nome do GA</label><input name="nome_gestor"
                                class="form-control" required></div>
                        <div class="col-md-6"><label class="form-label">Email do GA</label><input
                                name="email_gestor" type="email" class="form-control" required></div>
                        <div class="col-md-6">
                            <label class="form-label">Nome do Kit</label>
                            <select name="nome_kit" id="selectNomeKitColab" class="form-select" required>
                                <option value="" disabled selected>Selecione o Kit</option>
                                {% for kit in kits %}
                                <option value="{{ kit.nome_kit }}" data-idkit="{{ kit.id_kit }}">{{ kit.nome_kit }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">ID do Kit</label>
                            <input type="text" id="inputIdKitColab" name="id_kit" class="form-control" required>
                        </div>
                        <div class="col-md-6"><label class="form-label">Data de Admissão</label><input
                                name="data_admissao" type="date" class="form-control" required></div>
                        <div class="col-md-6">
                            <label class="form-label">Tamanho da Camisa</label>
                            <select name="tamanho_camisa" class="form-select" required>
                                <option value="" disabled selected>Selecione</option>
                                {% for t in ['PP','P','M','G','GG','XG'] %}<option value="{{ t }}">{{ t }}</option>{%
                                endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Agência</label>
                            <select id="selectAgencia" class="form-select" required>
                                <option value="" disabled selected>Selecione a Agência</option>
                                {% for agencia in agencias %}
                                <option value="{{ agencia.id_agencia }}" data-local="{{ agencia.local_envio }}"
                                    data-nome="{{ agencia.nome_agencia }}">{{ agencia.nome_agencia }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6"><label class="form-label">Local de Envio</label><input
                                id="inputLocalEnvio" name="local_envio" class="form-control" readonly></div>
                        <div class="col-md-6"><label class="form-label">ID Agência</label><input id="inputIdAgencia"
                                name="id_agencia" class="form-control"></div>
                        <input type="hidden" name="nome_agencia" id="inputNomeAgencia">
                        <div class="col-md-6">
                            <label class="form-label">Situação</label>
                            <select name="situacao" class="form-select" required>
                                <option value="" disabled selected>Selecione</option>
                                <option value="pendente">Pendente</option>
                                <option value="montar">Montar</option>
                                <option value="entregue">Entregue</option>
                                <option value="enviado">Enviado</option>
                                <option value="Ativo">Ativo</option>
                                <option value="Inativo">Inativo</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer"><button type="submit" name="adicionar_colaborador"
                        class="btn btn-success">Adicionar</button><button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Cancelar</button></div>
            </form>
        </div>
    </div>
</div>

<!-- Adicionar Kit -->
<div class="modal fade" id="modalAdicionarKits" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="post" action="{{ url_for('rh') }}">
        <input type="hidden" name="adicionar_kit" value="1">

        <div class="modal-header">
          <h5 class="modal-title">Adicionar Kit</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">ID do Kit</label>
              <input type="text" name="id_kit" class="form-control" required>
            </div>
            <div class="col-md-8">
              <label class="form-label">Nome do Kit</label>
              <input type="text" name="nome_kit" class="form-control" required>
            </div>

            <div class="col-md-4">
              <label class="form-label">ID do Item (opcional)</label>
              <input type="text" name="id_item" class="form-control">
            </div>
            <div class="col-md-8">
              <label class="form-label">Item (descrição)</label>
              <input type="text" name="item" class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Tamanho da Camisa (opcional)</label>
              <select name="tamanho_camisa" class="form-select">
                <option value="">—</option>
                {% for t in ['PP','P','M','G','GG','XG'] %}
                  <option value="{{ t }}">{{ t }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Adicionar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script id="class-map-data" type="application/json">
  {{ class_map|tojson }}
</script>

<script>
    // ====== Filtro por coluna (genérico) ======
    function setupColumnFilter(selectId, inputId, tableBodySelector) {
        const sel = document.getElementById(selectId);
        const inp = document.getElementById(inputId);
        const tbody = document.querySelector(tableBodySelector);
        if (!sel || !inp || !tbody) return;

        function apply() {
            const cls = sel.value;
            const q = (inp.value || "").toLowerCase().trim();
            const rows = tbody.querySelectorAll("tr");
            rows.forEach(tr => {
                if (!cls) { tr.style.display = ""; return; }
                const cell = tr.querySelector("." + cls);
                const txt = (cell ? cell.textContent : "").toLowerCase().trim();
                tr.style.display = txt.includes(q) ? "" : "none";
            });
        }
        sel.addEventListener("change", () => {
            const has = !!sel.value;
            inp.classList.toggle("d-none", !has);
            const optText = has ? sel.options[sel.selectedIndex].textContent : "";
            inp.placeholder = has ? `Pesquisar por ${optText.toLowerCase()}…` : "Digite para filtrar…";
            inp.value = "";
            apply();
            if (has) inp.focus();
        });
        inp.addEventListener("input", apply);
    }
    setupColumnFilter("usersFiltroColuna", "usersFiltroValor", "#tabelaUsuarios tbody");
    setupColumnFilter("colabFiltroColuna", "colabFiltroValor", "#tabelaColaboradores tbody");
    setupColumnFilter("estqFiltroColuna", "estqFiltroValor", "#tabelaEstoque tbody");
    setupColumnFilter("kitsFiltroColuna", "kitsFiltroValor", "#tabelaKits tbody");

    // ====== Carrega CLASS_MAP do JSON embutido ======
    const CLASS_MAP = (() => {
        try {
            const el = document.getElementById('class-map-data');
            return el ? JSON.parse(el.textContent) : {};
        } catch (e) {
            console.error('Falha ao carregar CLASS_MAP:', e);
            return {};
        }
    })();

    // ====== Preencher id_classe automaticamente quando escolher a Classe ======
    function bindClasseAutoFill(scope) {
        (scope || document).querySelectorAll('select[name="nome_classe"]').forEach(sel => {
            const form = sel.closest('form') || document;
            const idInput = form.querySelector('input[name="id_classe"]');
            function update() { if (idInput) idInput.value = CLASS_MAP[sel.value] || ""; }
            sel.addEventListener("change", update);
            update();
        });
    }
    bindClasseAutoFill(document);
    document.querySelectorAll('#modalAdicionarUsuario, [id^="modalEditarUsuario-"]').forEach(m => {
        m.addEventListener('shown.bs.modal', () => bindClasseAutoFill(m));
    });

    // ====== Preencher campos de Agência (modal Adicionar Colaborador) ======
    (function () {
        const selectAgencia = document.getElementById("selectAgencia");
        const inputIdAgencia = document.getElementById("inputIdAgencia");
        const inputLocalEnvio = document.getElementById("inputLocalEnvio");
        const inputNomeAgencia = document.getElementById("inputNomeAgencia");
        if (!selectAgencia) return;
        selectAgencia.addEventListener("change", () => {
            const opt = selectAgencia.options[selectAgencia.selectedIndex];
            inputIdAgencia.value = opt ? (opt.value || "") : "";
            inputLocalEnvio.value = opt ? (opt.getAttribute("data-local") || "") : "";
            inputNomeAgencia.value = opt ? (opt.getAttribute("data-nome") || "") : "";
        });
    })();

    // ====== Preencher ID/Nome do Kit (modal Adicionar Estoque) ======
    (function () {
        const selectKit = document.getElementById("selectKitEstoque");
        const inputIdKit = document.getElementById("inputIdKitEstoque");
        const inputNomeKit = document.getElementById("inputNomeKitEstoque");
        if (!selectKit) return;
        selectKit.addEventListener("change", () => {
            const opt = selectKit.options[selectKit.selectedIndex];
            inputIdKit.value = opt ? (opt.value || "") : "";
            inputNomeKit.value = opt ? (opt.getAttribute("data-nome") || "") : "";
        });
    })();

    (function () {
        const sel = document.getElementById("selectNomeKitColab");
        const idInput = document.getElementById("inputIdKitColab");
        if (!sel || !idInput) return;
        sel.addEventListener("change", () => {
            const opt = sel.options[sel.selectedIndex];
            idInput.value = opt ? (opt.getAttribute("data-idkit") || "") : "";
        });
    })();

    // ====== Preencher campos de Agência (modal Adicionar Colaborador) ======
    (function () {
        const selectAgencia = document.getElementById("selectAgencia");
        const inputIdAgencia = document.getElementById("inputIdAgencia");
        const inputLocalEnvio = document.getElementById("inputLocalEnvio");
        const inputNomeAgencia = document.getElementById("inputNomeAgencia");
        if (!selectAgencia) return;
        selectAgencia.addEventListener("change", () => {
            const opt = selectAgencia.options[selectAgencia.selectedIndex];
            inputIdAgencia.value = opt ? (opt.value || "") : "";
            inputLocalEnvio.value = opt ? (opt.getAttribute("data-local") || "") : "";
            inputNomeAgencia.value = opt ? (opt.getAttribute("data-nome") || "") : "";
        });
    })();

</script>

{% endblock %}